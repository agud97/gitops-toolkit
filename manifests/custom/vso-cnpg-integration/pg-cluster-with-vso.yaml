# =============================================================================
# CloudNativePG Cluster with VSO-managed secrets
# =============================================================================
# Этот кластер использует секреты, синхронизированные из Vault через VSO
# для managed roles (пользователей базы данных).
#
# Prerequisite: VSO secrets должны быть синхронизированы
# =============================================================================

apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: cnpg-system
spec:
  instances: 2  # 1 primary + 1 replica

  # PostgreSQL версия
  imageName: ghcr.io/cloudnative-pg/postgresql:17.2

  # Bootstrap - создание начальной БД
  bootstrap:
    initdb:
      database: app
      owner: app
      # Секрет для app пользователя (из VSO)
      secret:
        name: secret-app

  # Storage
  storage:
    size: 20Gi
    # storageClass: fast-ssd

  # Resources
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 2Gi
      cpu: 1000m

  # PostgreSQL конфигурация
  postgresql:
    parameters:
      shared_buffers: "256MB"
      effective_cache_size: "768MB"
      max_connections: "200"
      work_mem: "16MB"
      log_statement: "ddl"
      log_min_duration_statement: "1000"

  # Managed Roles - пароли из VSO secrets
  managed:
    roles:
      # Keycloak
      - name: keycloak
        ensure: present
        login: true
        createdb: true
        passwordSecret:
          name: secret-keycloak

      # Kong
      - name: kong
        ensure: present
        login: true
        createdb: true
        passwordSecret:
          name: secret-kong

      # Application user
      - name: app
        ensure: present
        login: true
        superuser: false
        createdb: false
        passwordSecret:
          name: secret-app

      # Добавьте дополнительных пользователей по необходимости:
      # - name: your-service
      #   ensure: present
      #   login: true
      #   passwordSecret:
      #     name: secret-your-service

  # Monitoring
  monitoring:
    enablePodMonitor: true

  # Affinity
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred

---
# =============================================================================
# Databases - создание БД для сервисов
# =============================================================================
# Выполняется после создания кластера
# =============================================================================

# Раскомментируйте для автоматического создания БД:
# apiVersion: postgresql.cnpg.io/v1
# kind: Database
# metadata:
#   name: keycloak-db
#   namespace: cnpg-system
# spec:
#   name: keycloak
#   owner: keycloak
#   cluster:
#     name: pg-cluster
#
# ---
# apiVersion: postgresql.cnpg.io/v1
# kind: Database
# metadata:
#   name: kong-db
#   namespace: cnpg-system
# spec:
#   name: kong
#   owner: kong
#   cluster:
#     name: pg-cluster
