# =============================================================================
# Keycloak Instance
# =============================================================================
# Требует: Keycloak Operator, PostgreSQL (CNPG)
#
# Для интеграции с VSO см. manifests/custom/vso-cnpg-integration/
# Секрет keycloak-db-secret можно синхронизировать из Vault
# =============================================================================

apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
  namespace: keycloak
spec:
  # Количество реплик
  instances: 1  # Увеличьте до 2+ для production

  # Database (PostgreSQL через CNPG)
  db:
    vendor: postgres
    host: pg-cluster-rw.cnpg-system.svc.cluster.local
    port: 5432
    database: keycloak
    usernameSecret:
      name: keycloak-db-secret
      key: username
    passwordSecret:
      name: keycloak-db-secret
      key: password

  # HTTP/HTTPS
  http:
    httpEnabled: true
    httpPort: 8080
    httpsPort: 8443
    # tlsSecret: keycloak-tls

  # Hostname - ИЗМЕНИТЕ на ваш домен
  hostname:
    hostname: keycloak.example.com
    # strict: true
    # strictBackchannel: true

  # Proxy settings (для работы за reverse proxy/ingress)
  proxy:
    headers: xforwarded

  # Additional options
  additionalOptions:
    - name: metrics-enabled
      value: "true"
    - name: health-enabled
      value: "true"
    - name: log-level
      value: "INFO"
    - name: cache
      value: "ispn"

  # Resources
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

---
# =============================================================================
# Database Secret (PLACEHOLDER)
# =============================================================================
# В production используйте VSO для синхронизации из Vault
# или External Secrets Operator
#
# Для VSO создайте VaultStaticSecret в namespace keycloak:
#   path: cnpg/keycloak
#   destination.name: keycloak-db-secret
# =============================================================================

apiVersion: v1
kind: Secret
metadata:
  name: keycloak-db-secret
  namespace: keycloak
  annotations:
    description: "PLACEHOLDER - use VSO or External Secrets in production"
type: Opaque
stringData:
  username: keycloak
  password: CHANGE_ME  # Замените или используйте VSO

---
# =============================================================================
# Ingress для Keycloak
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: keycloak-ingress
  namespace: keycloak
  annotations:
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  rules:
    - host: keycloak.example.com  # ИЗМЕНИТЕ
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: keycloak-service
                port:
                  number: 8080
  # TLS
  # tls:
  #   - hosts:
  #       - keycloak.example.com
  #     secretName: keycloak-tls

---
# =============================================================================
# Keycloak Realm Import (опционально)
# =============================================================================

# apiVersion: k8s.keycloak.org/v2alpha1
# kind: KeycloakRealmImport
# metadata:
#   name: app-realm-import
#   namespace: keycloak
# spec:
#   keycloakCRName: keycloak
#   realm:
#     realm: app
#     enabled: true
#     displayName: "Application Realm"
#     registrationAllowed: false
#     loginWithEmailAllowed: true
#     duplicateEmailsAllowed: false
#     resetPasswordAllowed: true
#     editUsernameAllowed: false
#     bruteForceProtected: true
