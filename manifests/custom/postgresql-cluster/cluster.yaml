# =============================================================================
# CloudNativePG PostgreSQL Cluster
# =============================================================================
# High-availability PostgreSQL кластер с автоматическим failover
#
# Для интеграции с VSO см. manifests/custom/vso-cnpg-integration/
# =============================================================================

apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: pg-cluster
  namespace: cnpg-system
spec:
  # Количество инстансов (1 primary + N-1 replicas)
  instances: 2  # Увеличьте до 3 для production

  # PostgreSQL версия
  imageName: ghcr.io/cloudnative-pg/postgresql:17.2

  # Bootstrap - инициализация кластера
  bootstrap:
    initdb:
      database: app
      owner: app
      # Секрет с паролем (из VSO или вручную)
      # secret:
      #   name: secret-app

  # Storage
  storage:
    size: 20Gi
    # storageClass: fast-ssd  # Укажите ваш StorageClass

  # Resources
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 2Gi
      cpu: 1000m

  # PostgreSQL конфигурация
  postgresql:
    parameters:
      # Memory
      shared_buffers: "256MB"
      effective_cache_size: "768MB"
      work_mem: "16MB"
      maintenance_work_mem: "128MB"

      # Connections
      max_connections: "200"

      # WAL
      wal_buffers: "16MB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"

      # Logging
      log_statement: "ddl"
      log_min_duration_statement: "1000"

      # Locale
      timezone: "UTC"

  # Managed Roles - пользователи БД
  # Пароли из Kubernetes secrets (можно синхронизировать через VSO)
  managed:
    roles:
      # Keycloak
      - name: keycloak
        ensure: present
        login: true
        createdb: true
        passwordSecret:
          name: secret-keycloak

      # Kong (если используется режим с БД)
      - name: kong
        ensure: present
        login: true
        createdb: true
        passwordSecret:
          name: secret-kong

      # Application user
      - name: app
        ensure: present
        login: true
        createdb: false
        passwordSecret:
          name: secret-app

      # Добавьте дополнительных пользователей по необходимости

  # Monitoring
  monitoring:
    enablePodMonitor: true

  # Affinity для распределения по нодам
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred

---
# =============================================================================
# Production Cluster Example (отдельный файл pg-cluster-prod.yaml)
# =============================================================================
# Для production раскомментируйте и адаптируйте:

# apiVersion: postgresql.cnpg.io/v1
# kind: Cluster
# metadata:
#   name: pg-cluster-prod
#   namespace: cnpg-system
# spec:
#   instances: 3
#
#   imageName: ghcr.io/cloudnative-pg/postgresql:17.2
#
#   bootstrap:
#     initdb:
#       database: app
#       owner: app
#
#   storage:
#     size: 100Gi
#     storageClass: fast-ssd
#
#   resources:
#     requests:
#       memory: 2Gi
#       cpu: 1000m
#     limits:
#       memory: 8Gi
#       cpu: 4000m
#
#   postgresql:
#     parameters:
#       shared_buffers: "2GB"
#       effective_cache_size: "6GB"
#       work_mem: "64MB"
#       maintenance_work_mem: "512MB"
#       max_connections: "400"
#       wal_buffers: "64MB"
#       min_wal_size: "2GB"
#       max_wal_size: "8GB"
#       random_page_cost: "1.1"
#       effective_io_concurrency: "200"
#
#   # Backup to S3
#   backup:
#     barmanObjectStore:
#       destinationPath: s3://your-bucket/postgresql/
#       endpointURL: https://s3.your-region.amazonaws.com
#       s3Credentials:
#         accessKeyId:
#           name: s3-backup-creds
#           key: ACCESS_KEY_ID
#         secretAccessKey:
#           name: s3-backup-creds
#           key: SECRET_ACCESS_KEY
#       wal:
#         compression: gzip
#       data:
#         compression: gzip
#     retentionPolicy: "30d"
#
#   managed:
#     roles:
#       - name: keycloak
#         ensure: present
#         login: true
#         createdb: true
#         passwordSecret:
#           name: secret-keycloak
#       - name: kong
#         ensure: present
#         login: true
#         createdb: true
#         passwordSecret:
#           name: secret-kong
#       - name: app
#         ensure: present
#         login: true
#         passwordSecret:
#           name: secret-app
#
#   monitoring:
#     enablePodMonitor: true
#
#   affinity:
#     enablePodAntiAffinity: true
#     topologyKey: kubernetes.io/hostname
#     podAntiAffinityType: required

---
# =============================================================================
# Scheduled Backup
# =============================================================================

# apiVersion: postgresql.cnpg.io/v1
# kind: ScheduledBackup
# metadata:
#   name: pg-cluster-backup
#   namespace: cnpg-system
# spec:
#   schedule: "0 2 * * *"  # Ежедневно в 2:00
#   backupOwnerReference: self
#   cluster:
#     name: pg-cluster
#   immediate: true
#   suspend: false
