# =============================================================================
# Kong Declarative Configuration
# =============================================================================
# DBless mode конфигурация маршрутов
# Редактируйте services и routes под ваши нужды
#
# Примечание: Namespace и хосты сервисов - placeholder'ы.
# Измените под вашу структуру: service.namespace.svc.cluster.local
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # ==========================================================================
    # Services & Routes - BFF (Backend for Frontend)
    # ==========================================================================

    services:
      # --------------------------------------------------------------------------
      # User Service
      # --------------------------------------------------------------------------
      - name: user-service
        host: user-service.app.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 3
        routes:
          - name: user-service-route
            paths:
              - /api/v1/bff/users
            protocols:
              - http
              - https
            strip_path: true
            preserve_host: false

      # --------------------------------------------------------------------------
      # Account Service
      # --------------------------------------------------------------------------
      - name: account-service
        host: account-service.app.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 3
        routes:
          - name: account-service-route
            paths:
              - /api/v1/bff/accounts
            strip_path: true

      # --------------------------------------------------------------------------
      # Wallet Service
      # --------------------------------------------------------------------------
      - name: wallet-service
        host: wallet-service.app.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 3
        routes:
          - name: wallet-service-route
            paths:
              - /api/v1/bff/wallet
            strip_path: true

      # --------------------------------------------------------------------------
      # Payment Service
      # --------------------------------------------------------------------------
      - name: payment-service
        host: payment-service.app.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 3
        routes:
          - name: payment-service-route
            paths:
              - /api/v1/bff/payments
            strip_path: true

      # --------------------------------------------------------------------------
      # Order Service
      # --------------------------------------------------------------------------
      - name: order-service
        host: order-service.app.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 3
        routes:
          - name: order-service-route
            paths:
              - /api/v1/bff/orders
            strip_path: true

      # --------------------------------------------------------------------------
      # Notification Service
      # --------------------------------------------------------------------------
      - name: notification-service
        host: notification-service.app.svc.cluster.local
        port: 8080
        protocol: http
        routes:
          - name: notification-service-route
            paths:
              - /api/v1/bff/notifications
            strip_path: true

      # --------------------------------------------------------------------------
      # Admin Backend (Backoffice API)
      # --------------------------------------------------------------------------
      - name: admin-backend
        host: admin-backend.app.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 3
        routes:
          - name: admin-backend-route
            paths:
              - /api/v1/bo
            strip_path: true

      # --------------------------------------------------------------------------
      # Auth Service (если не используете Keycloak напрямую)
      # --------------------------------------------------------------------------
      - name: auth-service
        host: auth-service.app.svc.cluster.local
        port: 8080
        protocol: http
        routes:
          - name: auth-route
            paths:
              - /api/v1/auth
            methods:
              - GET
              - POST
              - PUT
              - DELETE
            strip_path: true

    # ==========================================================================
    # Plugins (глобальные)
    # ==========================================================================

    plugins:
      # Correlation ID для трассировки запросов
      - name: correlation-id
        config:
          header_name: X-Correlation-ID
          generator: uuid
          echo_downstream: true

      # Rate limiting (глобальный)
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          policy: local
          fault_tolerant: true
          hide_client_headers: false

      # Prometheus metrics
      - name: prometheus
        config:
          status_code_metrics: true
          latency_metrics: true
          bandwidth_metrics: true
          upstream_health_metrics: true

      # CORS (если нужен)
      # - name: cors
      #   config:
      #     origins:
      #       - "*"
      #     methods:
      #       - GET
      #       - POST
      #       - PUT
      #       - DELETE
      #       - OPTIONS
      #     headers:
      #       - Accept
      #       - Authorization
      #       - Content-Type
      #       - X-Correlation-ID
      #     exposed_headers:
      #       - X-Correlation-ID
      #     credentials: true
      #     max_age: 3600

    # ==========================================================================
    # Consumers (для API Key аутентификации)
    # ==========================================================================

    # consumers:
    #   - username: mobile-app
    #     keyauth_credentials:
    #       - key: your-mobile-app-api-key
    #
    #   - username: web-app
    #     keyauth_credentials:
    #       - key: your-web-app-api-key

    # ==========================================================================
    # Upstreams с health checks (для продвинутого load balancing)
    # ==========================================================================

    # upstreams:
    #   - name: user-service-upstream
    #     algorithm: round-robin
    #     hash_on: none
    #     healthchecks:
    #       active:
    #         type: http
    #         http_path: /health
    #         healthy:
    #           interval: 5
    #           successes: 2
    #         unhealthy:
    #           interval: 5
    #           http_failures: 3
    #           timeouts: 3
    #       passive:
    #         healthy:
    #           successes: 5
    #         unhealthy:
    #           http_failures: 5
    #           timeouts: 5
    #     targets:
    #       - target: user-service.app.svc.cluster.local:8080
    #         weight: 100
