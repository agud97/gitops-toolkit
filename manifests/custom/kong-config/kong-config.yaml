# =============================================================================
# Kong Declarative Configuration
# =============================================================================
# DBless mode конфигурация маршрутов
# Редактируйте services и routes под ваши нужды
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # ==========================================================================
    # Services & Routes
    # ==========================================================================

    services:
      # --------------------------------------------------------------------------
      # Example: User Service
      # --------------------------------------------------------------------------
      - name: user-service
        host: user-service.default.svc.cluster.local
        port: 8080
        protocol: http
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        retries: 5
        routes:
          - name: user-service-route
            paths:
              - /api/v1/users
            protocols:
              - http
              - https
            strip_path: true
            preserve_host: false

      # --------------------------------------------------------------------------
      # Example: Auth Service
      # --------------------------------------------------------------------------
      - name: auth-service
        host: auth-service.default.svc.cluster.local
        port: 8080
        protocol: http
        routes:
          - name: auth-route
            paths:
              - /api/v1/auth
            methods:
              - GET
              - POST
            strip_path: true

      # --------------------------------------------------------------------------
      # Example: Backend API
      # --------------------------------------------------------------------------
      - name: backend-api
        url: http://backend.default.svc.cluster.local:8080
        routes:
          - name: backend-route
            paths:
              - /api/v1/backend
            strip_path: true

    # ==========================================================================
    # Plugins (глобальные)
    # ==========================================================================

    plugins:
      # Rate limiting
      - name: rate-limiting
        config:
          minute: 100
          policy: local
          fault_tolerant: true
          hide_client_headers: false

      # Correlation ID
      - name: correlation-id
        config:
          header_name: X-Correlation-ID
          generator: uuid
          echo_downstream: true

      # Request/Response logging (для отладки)
      # - name: file-log
      #   config:
      #     path: /dev/stdout
      #     reopen: true

    # ==========================================================================
    # Consumers (для аутентификации)
    # ==========================================================================

    # consumers:
    #   - username: api-consumer
    #     keyauth_credentials:
    #       - key: your-api-key-here

    # ==========================================================================
    # Upstreams (для load balancing)
    # ==========================================================================

    # upstreams:
    #   - name: user-service-upstream
    #     algorithm: round-robin
    #     healthchecks:
    #       active:
    #         healthy:
    #           interval: 5
    #           successes: 2
    #         unhealthy:
    #           interval: 5
    #           http_failures: 3
    #     targets:
    #       - target: user-service-1.default.svc.cluster.local:8080
    #         weight: 100
    #       - target: user-service-2.default.svc.cluster.local:8080
    #         weight: 100
