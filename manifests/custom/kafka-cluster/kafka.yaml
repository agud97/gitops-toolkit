# =============================================================================
# Kafka NodePool - Combined (Controller + Broker)
# =============================================================================
# KRaft mode (без ZooKeeper) - Kafka 4.0
# =============================================================================

apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: combined
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  replicas: 3  # Для production минимум 3
  roles:
    - controller
    - broker
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 50Gi
        # storageClass: fast-ssd  # Укажите ваш StorageClass
        deleteClaim: false
        kraftMetadata: shared

  resources:
    requests:
      memory: 1Gi
      cpu: 500m
    limits:
      memory: 2Gi
      cpu: 1000m

  # JVM настройки
  jvmOptions:
    -Xms: 512m
    -Xmx: 1024m

---
# =============================================================================
# Kafka Cluster (KRaft mode)
# =============================================================================

apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: kafka-cluster
  annotations:
    strimzi.io/node-pools: enabled
    strimzi.io/kraft: enabled
spec:
  kafka:
    version: 4.0.0

    # Metadata version для KRaft
    metadataVersion: "4.0-IV3"

    # Listeners
    listeners:
      # Internal plaintext
      - name: plain
        port: 9092
        type: internal
        tls: false

      # Internal TLS
      - name: tls
        port: 9093
        type: internal
        tls: true

      # External (опционально)
      # - name: external
      #   port: 9094
      #   type: nodeport
      #   tls: true

    # Kafka конфигурация
    config:
      # Replication
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2

      # Topics
      auto.create.topics.enable: false
      delete.topic.enable: true

      # Retention
      log.retention.hours: 168  # 7 дней
      log.retention.bytes: -1

      # Performance
      num.partitions: 3
      num.network.threads: 3
      num.io.threads: 8
      socket.send.buffer.bytes: 102400
      socket.receive.buffer.bytes: 102400
      socket.request.max.bytes: 104857600

      # Compression
      compression.type: producer

  # Entity Operator
  entityOperator:
    topicOperator:
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    userOperator:
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m

  # Kafka Exporter для метрик
  kafkaExporter:
    topicRegex: ".*"
    groupRegex: ".*"
    resources:
      requests:
        cpu: 100m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 128Mi

---
# =============================================================================
# Примеры KafkaTopic
# =============================================================================

# Events topic
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: events
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  partitions: 6
  replicas: 3
  config:
    retention.ms: 604800000      # 7 дней
    segment.bytes: 1073741824    # 1GB
    cleanup.policy: delete
    min.insync.replicas: 2

---
# Notifications topic
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: notifications
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  partitions: 3
  replicas: 3
  config:
    retention.ms: 86400000       # 1 день
    cleanup.policy: delete

---
# Commands topic (для CQRS)
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: commands
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  partitions: 6
  replicas: 3
  config:
    retention.ms: 259200000      # 3 дня
    cleanup.policy: delete

---
# Dead Letter Queue
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: dlq
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  partitions: 3
  replicas: 3
  config:
    retention.ms: 2592000000     # 30 дней
    cleanup.policy: delete

---
# =============================================================================
# Примеры KafkaUser
# =============================================================================

# Producer user
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: producer-app
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  authentication:
    type: scram-sha-512
  authorization:
    type: simple
    acls:
      - resource:
          type: topic
          name: events
          patternType: literal
        operations:
          - Write
          - Describe
        host: "*"
      - resource:
          type: topic
          name: commands
          patternType: literal
        operations:
          - Write
          - Describe
        host: "*"

---
# Consumer user
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: consumer-app
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  authentication:
    type: scram-sha-512
  authorization:
    type: simple
    acls:
      - resource:
          type: topic
          name: events
          patternType: literal
        operations:
          - Read
          - Describe
        host: "*"
      - resource:
          type: topic
          name: notifications
          patternType: literal
        operations:
          - Read
          - Describe
        host: "*"
      - resource:
          type: group
          name: consumer-
          patternType: prefix
        operations:
          - Read
        host: "*"

---
# Admin user (full access)
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: admin-user
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  authentication:
    type: scram-sha-512
  authorization:
    type: simple
    acls:
      - resource:
          type: topic
          name: "*"
          patternType: literal
        operations:
          - All
        host: "*"
      - resource:
          type: group
          name: "*"
          patternType: literal
        operations:
          - All
        host: "*"
      - resource:
          type: cluster
        operations:
          - All
        host: "*"
