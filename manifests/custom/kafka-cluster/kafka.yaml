# =============================================================================
# Kafka NodePool - Combined (Controller + Broker)
# =============================================================================
# KRaft mode - без ZooKeeper
# =============================================================================

apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaNodePool
metadata:
  name: combined
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  replicas: 3  # Для production минимум 3
  roles:
    - controller
    - broker
  storage:
    type: jbod
    volumes:
      - id: 0
        type: persistent-claim
        size: 50Gi
        # storageClass: fast-ssd  # Укажите ваш StorageClass
        deleteClaim: false
        kraftMetadata: shared

  resources:
    requests:
      memory: 1Gi
      cpu: 500m
    limits:
      memory: 2Gi
      cpu: 1000m

  # JVM настройки
  jvmOptions:
    -Xms: 512m
    -Xmx: 1024m

---
# =============================================================================
# Kafka Cluster
# =============================================================================

apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: kafka-cluster
  annotations:
    strimzi.io/node-pools: enabled
    strimzi.io/kraft: enabled
spec:
  kafka:
    version: 3.9.0  # Обновите при необходимости

    # Metadata version для KRaft
    metadataVersion: "3.9-IV0"

    # Listeners
    listeners:
      # Internal plaintext
      - name: plain
        port: 9092
        type: internal
        tls: false

      # Internal TLS
      - name: tls
        port: 9093
        type: internal
        tls: true

      # External (опционально) - NodePort/LoadBalancer/Ingress
      # - name: external
      #   port: 9094
      #   type: nodeport
      #   tls: true

    # Kafka конфигурация
    config:
      # Replication
      offsets.topic.replication.factor: 3
      transaction.state.log.replication.factor: 3
      transaction.state.log.min.isr: 2
      default.replication.factor: 3
      min.insync.replicas: 2

      # Topics
      auto.create.topics.enable: false  # Рекомендуется false для production
      delete.topic.enable: true

      # Retention
      log.retention.hours: 168  # 7 дней
      log.retention.bytes: -1   # Без лимита по размеру

      # Performance
      num.partitions: 3
      num.network.threads: 3
      num.io.threads: 8
      socket.send.buffer.bytes: 102400
      socket.receive.buffer.bytes: 102400
      socket.request.max.bytes: 104857600

      # Compression
      compression.type: producer

    # Rack awareness (для multi-AZ)
    # rack:
    #   topologyKey: topology.kubernetes.io/zone

  # Entity Operator - управление topics и users
  entityOperator:
    topicOperator:
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m
    userOperator:
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 512Mi
          cpu: 500m

  # Kafka Exporter для метрик (опционально)
  kafkaExporter:
    topicRegex: ".*"
    groupRegex: ".*"
    resources:
      requests:
        cpu: 100m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 128Mi

---
# =============================================================================
# Пример KafkaTopic
# =============================================================================

apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: example-topic
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  partitions: 3
  replicas: 3
  config:
    retention.ms: 604800000      # 7 дней
    segment.bytes: 1073741824    # 1GB
    cleanup.policy: delete

---
# =============================================================================
# Пример KafkaUser
# =============================================================================

apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: example-user
  labels:
    strimzi.io/cluster: kafka-cluster
spec:
  authentication:
    type: scram-sha-512
  authorization:
    type: simple
    acls:
      # Чтение из топиков
      - resource:
          type: topic
          name: example-topic
          patternType: literal
        operations:
          - Read
          - Describe
        host: "*"
      # Запись в топики
      - resource:
          type: topic
          name: example-topic
          patternType: literal
        operations:
          - Write
          - Describe
        host: "*"
      # Consumer group
      - resource:
          type: group
          name: example-group
          patternType: prefix
        operations:
          - Read
        host: "*"
